# EU規制解析ツールの使用に関する注意点

## HTML解析ツール（eu_reg_html_analyzer.py）

以下では、提示いただいたDMA用のコードを他のHTMLベースのEU法令に拡張する際に考慮すべきポイントや改善のヒントをまとめます。コードの全体的な流れ（HTML取得→構文解析→JSON化）は活用しつつ、法令ごとのHTML構造の違いや運用上の課題に対応できるようにすることが主なテーマとなります。

1. HTML構造・クラス名への依存を減らす

現状の問題点
	•	コード内では eli-subdivision や oj-normal, oj-ti-art など、DMAのHTMLに特有と思われるクラス名・ID をハードコーディングしています。
	•	例えば、チャプターの検出に '^CHAPTER \w+' という英語のタイトル・正規表現を使っていたり、前文の抽出に id=lambda x: x and x.startswith('rct_') のような特定IDを使用しています。

改善の方向
	1.	複数パターンを許容する: 他のEU法令においても同様のクラスやIDが付与される場合は多いものの、異なる可能性も高いです。複数の候補を順に試すか、法令ごとにコンフィグファイルなどで設定できるようにしておくと柔軟に対応できます。
	2.	英語以外への対応: CHAPTER や ANNEX が他言語の場合、単純な文字列検索では検出できません。英語版だけでなく、他言語版のHTML構造を想定する場合は、該当部分のテキスト検索をクラス名ベースに変えるなど工夫が必要です（あるいは英語版HTMLだけを対象とする運用でも、整合性の確認が必須）。
	3.	要素探索ロジックの汎用化: BeautifulSoup での検索を階層的に行う際、ノード構造の変化に耐えられる書き方が必要になります。クラス名に加えてタグ構造（例: div > p > tableなど）のパターンを柔軟に扱う仕組みがあると安全です。

2. 前文（Recitals）や付属書（Annexes）など、構成要素の有無の差異

現状の問題点
	•	DMAでは前文、チャプター、条文（Article）、附属書（Annex）の構成が明確に分かれていますが、EU法令の中にはチャプターや附属書がない場合や、前文が別の形式で記載されている場合もあります。
	•	現在のコードは「必ず前文（rct_）やANNEXがある」ことを前提にしているロジックが多く、見つからなかったときには空リストを返すなどの動きになっています。

改善の方向
	1.	存在しない場合を想定する: 前文（Recitals）が存在しない場合、附属書が存在しない場合など、必ずしも全セクションがあるとは限らないため、見つからなかったときはスキップする・メッセージを出すなどの処理を明確化する。
	2.	複数の付属書への対応: DMAには事実上1つのAnnexしかありませんが、EU法令によっては Annex I, II, III… と複数あるケースがあります。該当箇所を一括で ANNEX という文字列検索するだけでなく、ANNEX I / ANNEX II などをループ処理できるようにすると良いでしょう。

3. 条文（Article）や章立て（Chapter）の表記ゆれ

現状の問題点
	•	'^CHAPTER \w+' や '^Article' の英語表記を前提としている。
	•	条文番号は英語版では「Article X」と書かれていますが、他の言語では "Artikel X"、あるいは構造が微妙に異なる場合もあります。

改善の方向
	1.	多言語対応または英語版のみの想定: もし多言語のHTMLを扱うのであれば、すべて英語版のHTMLに統一する運用をまず決めるのも一手です。多言語を同一ロジックで扱うには、検索文字列を辞書化するなどの工夫が必要になります。
	2.	Article番号の取得方法の抽象化: Article 2 のようにストリングから直接数字を抜き出す箇所（正規表現）を、法令単位のカスタマイズ項目として外出しできるようにすると、他法令にも流用しやすくなります。

4. 「定義規定」や「特別処理」が記事やパラグラフごとに異なる可能性

現状の問題点
	•	DMAの例では「Article 2」が定義（Definitions）の特別処理対象になっており、テーブル構造で定義を抽出するロジックが組まれています。
	•	他の規則・指令等では 定義がArticle 1に書いてある、あるいは定義を附属書で行っているケースもあります。

改善の方向
	1.	定義専用のArticle番号を外部設定に: 「どの条文がDefinitionを含むか」は法令ごとに異なるため、設定ファイルやメタデータで「定義の条文番号」を指定できるようにする。
	2.	テーブル構造以外の定義形式への対応: 定義がテーブルではなく、通常のリストや箇条書きで書かれている場合も多いです。特別なマークアップ（サブパラグラフの抽出）だけでなく、箇条書きタグ（<ul>, <ol>）や p の羅列でも定義を把握できるよう、ロジックを汎用化する。

5. パラグラフ番号やサブパラグラフ番号の抽出方法

現状の問題点
	•	^\d+\.\s* や ^\(\d+\) のような正規表現で段落番号を検索し、それ以外のテキストを「Chapeau」として扱うロジック。
	•	他法令では段落番号が (1) 形式だったり、 1), １．（全角）、ローマ数字 (i) など多様です。

改善の方向
	1.	番号形式を複数想定: ^\d+\. だけでなく、^\(\d+\) や ローマ数字 などのパターンを追加して汎用化するか、法令ごとに設定できるようにする。
	2.	Chapeau部分の取得ルールの検討: そもそもパラグラフ番号が存在しない法令や、「冒頭に必ず段落番号が振られるわけではない」法令もあります。すべてに共通する「冒頭文→以下サブパラグラフ」という構造を固定化しないほうが柔軟に対応できます。

6. 付属書(ANNEX)・セクション抽出の汎用化

現状の問題点
	•	DMAの附属書は単一で、内容を「セクション A・B・C…」という特定の構造でパースする前提になっています。
	•	他法令ではAnnexの数が複数あったり、Section見出しがない/異なるマークアップであったりします。

改善の方向
	1.	複数Annexのサポート: ANNEX I, II, III... が出てきたら各Annexをループ処理し、抽出結果をリストに追加する形にする。
	2.	セクション/サブセクション解析の汎用化: DMAのA, B, C区切りやEセクションのテーブル解析は特殊ケースです。他法令では全く異なる区分方法があるため、ANNEX 全体の大きな流れを抽出しつつ、細分化は拡張ポイントとして扱うようにする。

7. 正規化処理（\n, 複数スペースの除去など）の適用範囲・漏れのチェック

現状の問題点
	•	_normalize_text() で、改行→スペース置換・複数スペース→単一スペース、句読点やかっこ前後のスペース調整などを行っています。
	•	他の法令では、脚注や参照条文などが途中で挟まる場合もありますが、そのまま正規化すると情報が失われることがあります。

改善の方向
	1.	脚注や引用部分の扱い: <sup> や <a> タグなど、脚注や内部リンクをどう扱うか検討（除去/保留/メタデータとして別格処理など）。
	2.	外部参照（他条文・他法令）のハンドリング: 例えば「(See Article 3)」のような参照をメタデータとして切り出すなど、高度な解析が必要になる場合があります。まずは文字列を単に正規化するだけか、追加情報として保持するかをルール化する。
	3.	余計な改行や空白の扱い: 法令によってはHTML内の改行が論理的な分割を示すわけではないケースもあります。改行や空白を単純に除去するのではなく、ある程度の区切りとみなすかどうかを検討する。

8. 例外やエラー処理の拡充

現状の問題点
	•	例外発生時に print でエラーメッセージを表示し、スタックトレースを出力するだけ。
	•	実行環境によってはログが大量になったり、途中で失敗して終了してしまう可能性がある。

改善の方向
	1.	ログのレベル分け: info, warning, error など、重要度別に整理する（logging モジュールを活用）。
	2.	継続実行可能なエラーと停止すべきエラーの切り分け: 1つの条文抽出で失敗しても、他の条文の抽出を続行して最終的に部分的にでもデータを残すのかどうかを決める。
	3.	メッセージ多言語化やUIへの連携: ツールとして実装するのであれば、エラー時の動作（リトライや通知など）の仕様を詰めると運用が安定する。

9. 抽出データの構造・スキーマ設計の見直し

現状の問題点
	•	抽出結果を recitals, chapters, articles, annexes の4大要素にまとめ、それぞれJSONに出力しています。
	•	他法令では「チャプターがない」「前文が異なる扱い」など、必ずしもこの構成にあてはまらないケースがあります。

改善の方向
	1.	柔軟なスキーマ: すべての法令が必ず持つわけではない要素を、必須キーとして設計しない。存在しないときは空配列/Nullでも正しい扱いができるようにする。
	2.	追加要素への対応: 他法令で必要となる可能性がある「節（Section）」や「部（Part）」などの概念をどう吸収するか。追加キーを許容する、あるいはパラメータ化しておく。
	3.	メタデータの拡充: 例えば「改正バージョン」「条文が改正された日付」「引用の起点URL」など、より詳しい情報を取り込みたくなる場合もある。その際にJSON構造を拡張しやすい仕組みにしておく。

10. 多様なEU法令全体への横展開時に検討すべき点
	•	ドキュメント形式の違い: 規則(Regulation)、指令(Directive)、決定(Decision)などで条文の並びや見出しの付け方が異なる。
	•	バージョン管理: EUR-Lexにはコンソリデーション（改正込み）やオリジナル版など複数バージョンがある場合がある。対象とするバージョンを明確にする必要がある。
	•	言語選択: EUR-Lexは多言語版が存在するため、どの言語版HTMLを対象にするかの運用を固めておかないと、解析ルールが混乱する。
	•	文字コードや特殊文字: EU法令には各国言語特有の文字（ウムラウト、アクセント記号など）が含まれる場合もある。正規化処理で消してしまうと意味が変わる場合もあるので注意が必要。
	•	大規模法令: 文量が非常に多い法令の場合、パフォーマンス面や一時ファイルの扱いなどを最適化する必要がある（並列処理・分割保存など）。

まとめ

DMAのHTML構造に強く依存した部分（クラス名、ID、正規表現など）を切り出して「テンプレート／プラグイン」化し、法令ごとに差し替え可能にするか、もしくは可能な限り抽象度の高い（あるいは多パターンをカバーする）形に書き直すのが大きなポイントです。
	•	HTMLパターンの整理: まずは他のEU法令のHTMLをいくつかサンプル収集・比較し、共通するクラス名・構造と差異を洗い出す。
	•	設定可能な項目を増やす: たとえば「定義が書かれているArticle番号」「チャプター名の正規表現」「Annexの複数有無」などをユーザーがメタデータで指定できるようにする。
	•	エラー処理・ログ出力を強化: 不完全なHTMLや想定外の構造でも落ちずに最後まで解析できるようにし、問題箇所はログで報告するようにする。

こうした対策により、DMA以外のEU法令でも同じフレームワークを使って解析しやすくなります。

### 構造依存性の問題
1. **HTML構造への依存**
   - EUR-Lexの特定のHTML構造に強く依存
   - クラス名（'oj-ti-art'など）が固定的
   - セクション識別子（'art_'など）が特定の形式を前提

2. **DMA特有の構造解析**
   - Article 2（定義規定）の特別処理
   - 附属書（Annex）の処理がDMA形式に特化
   - 前文（recitals）の番号付けがDMA形式を前提

### 改善が必要な点
1. **柔軟性の向上**
   - 法令の構造を設定ファイルで定義できる機能
   - より柔軟なHTML構造の解析機能
   - 多言語対応の実装

2. **エラーハンドリング**
   - 異なる構造の法令での失敗時の対応
   - より詳細なエラーメッセージ
   - リカバリー機能の実装

3. **機能拡張**
   - 異なる種類の法令（規則、指令、決定）への対応
   - バージョン管理機能
   - 複雑な入れ子構造の解析機能

## データベースアップロードツール（upload_reg_to_supabase.py）

以下では、提示いただいた「DMAをSupabaseにアップロードする」コードを、他のEU法令でも利用可能なかたちへ拡張するときに考慮すべき注意点や改善策をまとめます。DMAに特化している部分や、他の法令では通用しないハードコードが散見されるため、それらをパラメータ化・設定化し、より柔軟なコードにしていくことが主眼となります。

1. 「DMA」へのハードコードを取り除き、汎用的なロジックへ

現状の問題点
	•	コード全体で「DMA」という文字列を前提に処理している（例: 既存データの削除やチェック時に name='DMA' をキーにしている）。
	•	「Digital Markets Act」という名前や、ソースURLなどが固定値として使用されている。
	•	Supabaseのテーブルregulationsに「DMA」としてINSERTしている。

改善の方向
	1.	法令名や英名（official_title）を外部パラメータで管理
	•	たとえば data['metadata']['name'] や data['metadata']['official_title'] を使用し、ハードコードの文言を極力排除する。
	•	既存データのチェックや削除時も、name='DMA' ではなく読み込んだデータのメタデータをキーにする。
	2.	ソースURLや施行日などもJSONに含める
	•	現在は source_url、document_date、effective_date などを固定していますが、法令ごとに異なる可能性が高いので、JSON 側 (dma_structured.json など) に保持させておき、その値を用いてINSERTする方式に変更する。

2. データ構造（recitals, chapters, articles, annexes）の前提を緩和

現状の問題点
	•	verify_data_structure()で['metadata', 'recitals', 'chapters', 'articles'] が必須のようになっている。
	•	しかし、他のEU法令では前文（recitals）が存在しない、チャプターの概念がないなど、すべてを必ず持つわけではない。

改善の方向
	1.	必須キーの柔軟化
	•	たとえば metadata と articles だけは必須、recitals や chapters、annexes はあればアップロードする、なければスキップするなどのロジックに変える。
	2.	データ構造のチェックやINSERTの前段階で条件分岐
	•	if 'recitals' in data: のように有無を確認してからINSERTする。
	•	スキップする場合はログだけ出力し、エラーとはみなさないようにする。

3. Supabaseテーブル構成との対応づけ

現状の問題点
	•	テーブル名（regulations, recitals, chapters, articles, paragraphs, paragraph_elements, annexes）はDMA向けに設計されている。
	•	他法令で同様のテーブル構成を使う想定なら問題ないが、法令によっては想定外の要素（たとえば部（Part）やSection）を持つ場合、どう扱うか曖昧。

改善の方向
	1.	テーブル間のER設計を明確にし、どのような法令でも共通構造として運用できるか検討
	•	例:
	•	regulations → 複数の articles を持つ
	•	articles → 複数の paragraphs を持つ
	•	paragraphs → paragraph_elements で細分化
	•	追加で recitals（あるなら入れる）, annexes（あるなら入れる）
	•	これで十分にあらゆるEU法令をモデリングできるなら、テーブルスキーマは流用可能。
	2.	法令固有要素の拡張余地
	•	もしチャプター以外にも「部（Part）」や「セクション（Section）」などが出る場合、chapters テーブルを「上位区分テーブル」として再利用できるのか（renameするか、一般化するか）などを検討する。

4. document.md による “chapter-article” マッピングの扱い

現状の問題点
	•	document.md から CSV 形式で「chapter, section, article」を読み込むコードが存在し、これを使ってチャプター番号をローマ数字で紐づけしている。
	•	これはDMA特有のマッピング（英語版のローマ数字チャプター vs. アラビア数字記事）を解決するための作業だが、他法令でも同じ形式のマッピングファイルが必要になるのか不明。

改善の方向
	1.	マッピングファイルが必須かどうかを選択式に
	•	必須でない法令の場合、document.md が存在しないことを想定してスキップするロジックを追加する。
	2.	ローマ数字以外のチャプター番号への対応
	•	たとえばChapter 1, Chapter 2のようにアラビア数字の場合もあれば、そもそもチャプターがない場合もある。
	3.	マッピングをデータ側（JSON）に含められるなら含める
	•	もし抽出時点で「どのArticleがどのChapterか」をJSON構造に埋め込んでおけば、このマッピングファイルを使わずに済む可能性がある。

5. ローマ数字周りの処理 (roman_to_int, to_roman)

現状の問題点
	•	DMAのチャプター番号はローマ数字を使っているが、他法令では異なる表記の場合がある。
	•	コード中でローマ数字への変換・逆変換を行っているが、そもそも必要ないケースもある。

改善の方向
	1.	チャプター番号の形式がローマ数字でない場合に備えた例外処理
	•	現在はローマ数字変換でエラーが出たら Warning: Invalid Roman numeral としているが、最初からローマ数字でない場合は単にそのまま扱えるようにする。
	2.	不要時には変換ロジックをスキップできるように
	•	マッピングファイルがアラビア数字で提供されるケースなどを想定する。

6. 既存データの削除・更新の扱い

現状の問題点
	•	既存データを「DMA」という名前で検索・削除している。
	•	他法令をアップロードする場合、同じ名前のデータが既にあるかどうかをチェックするロジックを流用する際、法令名をどう扱うかが問題になる。

改善の方向
	1.	法令名をJSONやCLIパラメータなどで受け取り、既存データの判定に使う
	2.	固有の識別子（例: CELEX番号やUUID）で既存データを判定する方法も検討する。
	3.	削除ではなくバージョンアップ/改訂を追記する運用もありうる。法令の改正版アップロードなどの場合は、「削除して再挿入」以外のバージョン管理ロジックが必要となるかもしれない。

7. Jurisdiction（管轄）テーブルの取り扱い

現状の問題点
	•	jurisdictions テーブルで code='EU' を検索し、なければ新規作成している。
	•	EU以外にも複数の管轄（EU以外の国際機関、国別等）に対応する場合を考える必要がある。

改善の方向
	1.	管轄が常に EU とは限らない
	•	EU法令だけなら問題ないが、EU外法令にも対応する計画があるならパラメータ化する。
	2.	EU法令でも特定のEU機関が発行した文書を区別したい場合
	•	すでにある「European Commission」「European Parliament and Council」などの違いをどう記録するか。

8. データのスキーマ・メタデータの拡充

現状の問題点
	•	regulation_data や metadata に固定値（uploaded_at, source, source_url など）が入っているが、EU法令によっては必要な情報が増えるかもしれない。
	•	たとえば「CELEX番号」や「OJ（Official Journal）番号」、改正履歴などをメタデータに含めたいケースがある。

改善の方向
	1.	EU法令のCELEX番号などの汎用的な識別子をサポート
	•	もしJSON側に格納していれば metadata["celex"] や metadata["oj_number"] のように取り込み、regulations テーブルの metadata カラムに追加する。
	2.	拡張可能なJSONフィールド
	•	Supabaseの列をJSONB型にしておき、将来的に柔軟に追加情報を持たせる設計にしておく。

9. 存在しないキーがあった場合のエラー処理とログ管理

現状の問題点
	•	たとえば annexes や recitals が存在しない法令の場合に、data['annexes'] を参照するとKeyErrorになる可能性がある。
	•	ログ出力はprintとtracebackに依存。大規模運用ではログ管理を整備する必要がある。

改善の方向
	1.	KeyErrorを回避するために data.get('annexes', []) のように書く
	•	安全にデフォルト値を返すようにし、存在しない場合はアップロードをスキップするかログメッセージを出す。
	2.	ログレベルの概念を導入
	•	print ではなく logging モジュールなどを使い、レベル別に制御 (info, warning, error) すると本番運用で扱いやすい。

10. 今後の拡張・運用上の留意点
	1.	改正時やバージョン管理への対応
	•	同じ法令名でも改訂版やコンソリデーション版をアップロードするとき、どうバージョン分けして格納するか。
	2.	言語バージョンの差異
	•	EUR-Lexは多言語HTMLが存在するが、現在のコードは英語版を前提にソースURLを設定している。複数言語を取り込む可能性があれば、その仕組みも検討。
	3.	ファイルパスやフォルダ構成
	•	dma_data/dma_structured.json というフォルダも法令固有になっているため、今後は structured_data/{law_name}.json など汎用化して管理すると便利。
	4.	エラー発生時の部分的完了
	•	途中で失敗してもすでにINSERTされたデータは残るため、どこまで成功したか追跡できるしくみ（トランザクション、一時テーブルなど）を整備するとリカバリしやすい。

まとめ
	•	「DMA」という文字列やローマ数字チャプターなど、DMA特有の処理が多いため、基本的に「法令固有の情報をすべて外部化（JSONやCSV、設定ファイルへ）」し、コード本体を汎用的にするのが最初の目標です。
	•	テーブル設計（regulations, chapters, articles, paragraphs, paragraph_elements, recitals, annexes）を、他のEU法令でも使えるか改めて検証し、不足があればメタデータ等で拡張可能にする。
	•	必須でない要素（recitalsやchapters等）が存在しないケースにも対応できるよう、キーの存在チェックやデフォルト処理を丁寧に実装する。
	•	document.mdでのマッピングやローマ数字変換はDMA以外で必要なければスキップできるように条件分岐・パラメータ化を行う。

こうした点を改善することで、他のEU法令に対しても同じアップロードロジックを適用しやすくなります。

### データ構造の制約
1. **テーブル構造**
   - 固定的なテーブル構造を前提
   - 特定のカラム名に依存
   - 関連テーブル間の関係が固定的

2. **データマッピング**
   - チャプター・条文の対応が特定のフォーマットを前提
   - ローマ数字変換が必要な箇所が固定
   - メタデータの構造が限定的

### 使用上の注意点
1. **前提条件**
   - Supabaseの特定のテーブル構造が必要
   - document.mdファイルの存在が必要
   - 特定の環境変数の設定が必要

2. **データ整合性**
   - 既存データの削除が必要な場合の注意
   - 関連テーブル間の整合性確保
   - トランザクション管理の必要性

3. **パフォーマンス**
   - 大量データ処理時の考慮
   - バッチ処理の必要性
   - メモリ使用量の最適化

## 今後の改善計画

1. **短期的な改善**
   - 設定ファイルによる構造定義の導入
   - エラーハンドリングの強化
   - ログ機能の改善

2. **中期的な改善**
   - 多言語対応の実装
   - テーブル構造の柔軟化
   - バッチ処理の最適化

3. **長期的な改善**
   - 異なる法令形式への対応
   - バージョン管理システムの導入
   - APIの標準化

## 使用時の推奨手順

1. **事前確認**
   - 対象法令のHTML構造の確認
   - 必要なテーブル構造の確認
   - 環境変数の設定確認

2. **テスト実行**
   - 小規模なデータでの動作確認
   - エラーケースの確認
   - データ整合性の確認

3. **本番適用**
   - バックアップの作成
   - 段階的なデータ移行
   - 結果の検証 